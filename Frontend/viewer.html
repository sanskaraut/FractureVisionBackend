<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Med3D â€“ Viewer</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
<div class="container">
  <div class="nav">
    <div><strong>Med3D</strong></div>
    <div class="small">Public view</div>
  </div>

  <div class="grid cols-2">
    <div class="card">
      <h2 id="title">Model</h2>
      <div id="viewer" class="viewer"></div>
    </div>
    <div class="card">
      <h3>Metadata</h3>
      <pre id="meta" class="small">{}</pre>
      <div class="small" id="time"></div>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'https://esm.sh/three@0.160.0';
import { GLTFLoader } from 'https://esm.sh/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
import { OrbitControls } from 'https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js';

const params = new URLSearchParams(location.search);
const id = params.get('id');
const container = document.getElementById('viewer');

if (!id) {
  container.textContent = 'Missing id';
  throw new Error('Missing id');
}

// Use relative URL so it works when frontend is served by the same server
const infoResp = await fetch(`/api/share/${id}`);
const info = await infoResp.json();
if (!infoResp.ok) {
  container.textContent = info.error || 'Not found';
  throw new Error(info.error || 'Not found');
}

document.getElementById('title').textContent = info.item.name;
document.getElementById('meta').textContent = JSON.stringify(info.item.meta || {}, null, 2);
document.getElementById('time').textContent = new Date(info.item.created_at).toLocaleString();

// ----- Three.js setup -----
const scene = new THREE.Scene();

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(container.clientWidth, container.clientHeight);
renderer.outputColorSpace = THREE.SRGBColorSpace;
renderer.toneMapping = THREE.ACESFilmicToneMapping;
renderer.toneMappingExposure = 1.0;
container.innerHTML = '';
container.appendChild(renderer.domElement);

const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.01, 1000);
camera.position.set(0, 1.5, 3);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// Lights
scene.add(new THREE.AmbientLight(0xffffff, 0.7));
const dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(3, 5, 2);
scene.add(dir);

const loader = new GLTF
