<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Med3D Viewer</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      background: linear-gradient(120deg, #232946 0%, #121821 100%);
      min-height: 100vh;
      margin: 0;
      font-family: 'Inter', system-ui, Arial, sans-serif;
      color: #e9eef5;
    }
    .container {
      max-width: 1200px;
      margin: 40px auto;
      padding: 32px;
      background: rgba(18, 24, 33, 0.95);
      border-radius: 18px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.45);
    }
    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
      font-size: 1.2rem;
      color: #4cc9f0;
    }
    .grid {
      display: grid;
      gap: 32px;
    }
    .grid.cols-2 {
      grid-template-columns: 2fr 1fr;
    }
    .card {
      background: #232946;
      border-radius: 16px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      padding: 24px;
      display: flex;
      flex-direction: column;
      min-height: 520px;
    }
    .viewer {
      height: 480px;
      background: #0f141b;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(76,201,240,0.08);
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
    }
    #loading {
      font-size: 1.2rem;
      color: #8aa0b2;
      position: absolute;
      left: 0; right: 0; top: 0; bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(18,24,33,0.7);
      z-index: 2;
    }
    h2, h3 {
      color: #4cc9f0;
      margin-bottom: 12px;
    }
    pre.small {
      background: #181f2a;
      color: #8aa0b2;
      border-radius: 8px;
      padding: 16px;
      font-size: 0.95rem;
      margin-bottom: 16px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .small {
      color: #8aa0b2;
      font-size: 0.95rem;
    }
    @media (max-width: 900px) {
      .grid.cols-2 {
        grid-template-columns: 1fr;
      }
      .container {
        padding: 12px;
      }
      .card {
        min-height: 320px;
        padding: 12px;
      }
      .viewer {
        height: 320px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div><strong>Med3D</strong></div>
      <div style="display:flex;align-items:center;gap:16px;">
        <div class="small">Public view</div>
        <button id="copyLinkBtn" class="btn" style="padding:6px 14px;font-size:1rem;">Copy Link</button>
      </div>
    </div>
    <div class="grid cols-2">
      <div class="card">
        <h2 id="title">Model</h2>
        <div id="viewer" class="viewer">
          <div id="loading">Loading model...</div>
        </div>
      </div>
      <div class="card">
        <h3>Metadata</h3>
        <pre id="meta" class="small">{}</pre>
        <div class="small" id="time"></div>
      </div>
    </div>
  </div>
  <script type="module">
    // Copy Link button logic
    const copyBtn = document.getElementById('copyLinkBtn');
    if (copyBtn) {
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(window.location.href)
          .then(() => {
            copyBtn.textContent = 'Copied!';
            setTimeout(() => { copyBtn.textContent = 'Copy Link'; }, 1200);
          })
          .catch(() => {
            copyBtn.textContent = 'Error';
            setTimeout(() => { copyBtn.textContent = 'Copy Link'; }, 1200);
          });
      });
    }
    import * as THREE from 'https://esm.sh/three@0.160.0';
    import { GLTFLoader } from 'https://esm.sh/three@0.160.0/examples/jsm/loaders/GLTFLoader.js';
    import { OrbitControls } from 'https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js';

    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    const container = document.getElementById('viewer');

    if (!id) {
      container.textContent = 'Missing id';
      throw new Error('Missing id');
    }

    // Use relative URL so it works when frontend is served by the same server
    let info;
    let infoResp;
    try {
      infoResp = await fetch(`/api/share/${id}`);
      info = await infoResp.json();
      if (!infoResp.ok) {
        container.innerHTML = `<div style='color:#e57373;text-align:center;padding:40px;'>${info.error || 'Not found'}</div>`;
        throw new Error(info.error || 'Not found');
      }
    } catch (err) {
      container.innerHTML = `<div style='color:#e57373;text-align:center;padding:40px;'>Failed to fetch model info.</div>`;
      throw err;
    }

    document.getElementById('title').textContent = info.item.name;
    document.getElementById('meta').textContent = JSON.stringify(info.item.meta || {}, null, 2);
    document.getElementById('time').textContent = new Date(info.item.created_at).toLocaleString();

    // ----- Three.js setup -----
    const scene = new THREE.Scene();

    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.0;
    container.innerHTML = '';
    container.appendChild(renderer.domElement);

    const camera = new THREE.PerspectiveCamera(60, container.clientWidth / container.clientHeight, 0.01, 1000);
    camera.position.set(0, 1.5, 3);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff, 1.5)); // Increased intensity
  // Main front/top light
  const dir1 = new THREE.DirectionalLight(0xffffff, 2.5);
  dir1.position.set(3, 5, 2);
  dir1.castShadow = true;
  scene.add(dir1);
  // Back light
  const dir2 = new THREE.DirectionalLight(0xffffff, 1.5);
  dir2.position.set(-3, 2, -4);
  scene.add(dir2);
  // Left light
  const dir3 = new THREE.DirectionalLight(0xffffff, 1.2);
  dir3.position.set(-5, 3, 2);
  scene.add(dir3);
  // Right light
  const dir4 = new THREE.DirectionalLight(0xffffff, 1.2);
  dir4.position.set(5, 3, 2);
  scene.add(dir4);

    const loader = new GLTFLoader();
    // Load the GLB model from the info response
    const loadingDiv = document.getElementById('loading');
    if (info.item.model_url) {
      loader.load(info.item.model_url, (gltf) => {
        scene.add(gltf.scene);
        if (loadingDiv) loadingDiv.remove();
      }, (xhr) => {
        if (loadingDiv) loadingDiv.textContent = `Loading model... ${(xhr.loaded / xhr.total * 100).toFixed(0)}%`;
      }, (error) => {
        if (loadingDiv) loadingDiv.textContent = 'Failed to load model.';
        container.innerHTML += `<div style='color:#e57373;text-align:center;padding:20px;'>Error loading model.</div>`;
        console.error(error);
      });
    } else {
      if (loadingDiv) loadingDiv.textContent = 'No model URL found.';
      container.innerHTML += `<div style='color:#e57373;text-align:center;padding:20px;'>No model URL found.</div>`;
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();
  </script>
// ...existing code...
</body>
</html>
